name: Build and Deploy Wisecow to EKS (Dummy)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: wisecow-cluster
  ECR_REPOSITORY: wisecow

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image-tag: ${{ github.sha }}
      image-uri: dummy-repo/wisecow:${{ github.sha }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Dummy AWS credentials setup
      run: |
        echo "Simulating AWS credentials configuration..."
        echo "AWS credentials configured successfully."

    - name: Dummy Docker build
      run: |
        echo "Building Wisecow Docker image (dummy build)..."
        sleep 3
        echo "Wisecow Docker image built successfully!"

    - name: Dummy image push
      run: |
        echo "Simulating Docker push to ECR/Docker Hub..."
        sleep 2
        echo "Image pushed successfully (dummy)."

    - name: Output image URI
      id: build-image
      run: |
        echo "image=dummy-repo/wisecow:${{ github.sha }}" >> $GITHUB_OUTPUT
        echo "Image URI generated: dummy-repo/wisecow:${{ github.sha }}"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Dummy AWS setup
      run: |
        echo "Simulating AWS EKS setup..."
        sleep 2
        echo "EKS setup complete (dummy)."

    - name: Dummy Kubeconfig update
      run: |
        echo "Simulating kubeconfig update for cluster $EKS_CLUSTER_NAME..."
        sleep 2
        echo "Kubeconfig updated (dummy)."

    - name: Dummy Kubernetes deployment
      run: |
        echo "Applying Kubernetes manifests (dry-run mode)..."
        echo "kubectl apply -f k8s/ --dry-run=client"
        sleep 3
        echo "All manifests validated successfully!"

    - name: Dummy deployment verification
      run: |
        echo "Simulating pod and service checks..."
        echo "All pods are running and services are healthy (dummy)."
        sleep 2

    - name: Dummy application URL output
      run: |
        echo "Application deployed successfully (dummy)."
        echo "Access it at: https://wisecow.example.com"
